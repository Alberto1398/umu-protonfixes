w_metadata mf_install dlls \
    title="MS Media Foundation" \
    publisher="Microsoft" \
    year="2011" \
    media="download" \
    file1="../win7sp1/windows6.1-KB976932-X86.exe" \
    installed_file1="$W_SYSTEM32_DLLS_WIN/mf.dll"

load_mf_install()
{
    # Apparently we need a lot more:
    # https://gist.github.com/Matoking/2017eeffc1cee82f4797530c67707437
    # https://lutris.net/games/install/10999/view
    # https://github.com/Winetricks/winetricks/issues/1132
    
    if [ ! -f "$W_CACHE/$W_PACKAGE/installcab.py" ]; then
        w_download_to "$W_CACHE/$W_PACKAGE" https://raw.githubusercontent.com/z0z0z/mf-installcab/master/installcab.py a32063ec2af233c6fdbc013e90977be46dc78d525cea5e699ab692f7850beabd installcab.py
    fi

    if [ ! -f "$W_CACHE/$W_PACKAGE/windows6.1-KB976932-X86.exe" ]; then
        w_download_to "$W_CACHE/$W_PACKAGE" https://download.microsoft.com/download/0/A/F/0AFB5316-3062-494A-AB78-7FB0D4461357/windows6.1-KB976932-X86.exe e5449839955a22fc4dd596291aff1433b998f9797e1c784232226aba1f8abd97 windows6.1-KB976932-X86.exe
    fi
    python2 "$W_CACHE/$W_PACKAGE/installcab.py" "$W_CACHE/$W_PACKAGE/windows6.1-KB976932-X86.exe" mediafoundation
    python2 "$W_CACHE/$W_PACKAGE/installcab.py" "$W_CACHE/$W_PACKAGE/windows6.1-KB976932-X86.exe" mf_
    python2 "$W_CACHE/$W_PACKAGE/installcab.py" "$W_CACHE/$W_PACKAGE/windows6.1-KB976932-X86.exe" mfreadwrite
    python2 "$W_CACHE/$W_PACKAGE/installcab.py" "$W_CACHE/$W_PACKAGE/windows6.1-KB976932-X86.exe" wmadmod
    python2 "$W_CACHE/$W_PACKAGE/installcab.py" "$W_CACHE/$W_PACKAGE/windows6.1-KB976932-X86.exe" wmvdecod
    python2 "$W_CACHE/$W_PACKAGE/installcab.py" "$W_CACHE/$W_PACKAGE/windows6.1-KB976932-X86.exe" wmadmod

    w_download_to "$W_CACHE/$W_PACKAGE" https://lutris.net/files/tools/dll/mfplat/x32/mfplat.dll 1d41496b65c6a3fd463a4e38f5ed856c1d283459e1cbaf8869dbdf2bfa5fc5ad mfplat.dll.32
    w_try cp "$W_CACHE/$W_PACKAGE/mfplat.dll.32" "$W_SYSTEM32_DLLS/mfplat.dll"

    w_download_to "$W_CACHE/$W_PACKAGE" https://github.com/z0z0z/mf-install/raw/master/system32/msmpeg2adec.dll 97a9b89b1b50cddf6adff9059dce5935d905796dbcd6db58ea2fa693caaa194a msmpeg2adec.dll.32
    w_try cp "$W_CACHE/$W_PACKAGE/msmpeg2adec.dll.32" "$W_SYSTEM32_DLLS/msmpeg2adec.dll"

    w_download_to "$W_CACHE/$W_PACKAGE" https://github.com/z0z0z/mf-install/raw/master/system32/msmpeg2vdec.dll d7d0bc980c658d5e2f2c605075338493eac97b9d7674007a9490846c2dcdf6f3 msmpeg2vdec.dll.32
    w_try cp "$W_CACHE/$W_PACKAGE/msmpeg2vdec.dll.32" "$W_SYSTEM32_DLLS/msmpeg2vdec.dll"

    w_download_to "$W_CACHE/$W_PACKAGE" https://github.com/z0z0z/mf-install/raw/master/system32/mferror.dll d9ce54938155a37f260b01d808917bc541383b750cd3a3094ce9308e318a0e2c mferror.dll.32
    w_try cp "$W_CACHE/$W_PACKAGE/mferror.dll.32" "$W_SYSTEM32_DLLS/mferror.dll"

    helper_win7sp1 x86_microsoft-windows-mediafoundation_31bf3856ad364e35_6.1.7601.17514_none_9e6699276b03c38e/mf.dll
    w_try cp "$W_TMP/x86_microsoft-windows-mediafoundation_31bf3856ad364e35_6.1.7601.17514_none_9e6699276b03c38e/mf.dll" "$W_SYSTEM32_DLLS/mf.dll"

    helper_win7sp1 x86_microsoft-windows-mfreadwrite_31bf3856ad364e35_6.1.7601.17514_none_bb5d51ef76468729/mfreadwrite.dll
    w_try cp "$W_TMP/x86_microsoft-windows-mfreadwrite_31bf3856ad364e35_6.1.7601.17514_none_bb5d51ef76468729/mfreadwrite.dll" "$W_SYSTEM32_DLLS/mfreadwrite.dll"

    helper_win7sp1 x86_microsoft-windows-sqmapi_31bf3856ad364e35_6.1.7601.17514_none_00451cf8631056b6/sqmapi.dll
    w_try cp "$W_TMP/x86_microsoft-windows-sqmapi_31bf3856ad364e35_6.1.7601.17514_none_00451cf8631056b6/sqmapi.dll" "$W_SYSTEM32_DLLS/sqmapi.dll"

    helper_win7sp1 x86_microsoft-windows-wmadmod_31bf3856ad364e35_6.1.7601.17514_none_885655287c3a2a8e/wmadmod.dll
    w_try cp "$W_TMP/x86_microsoft-windows-wmadmod_31bf3856ad364e35_6.1.7601.17514_none_885655287c3a2a8e/wmadmod.dll" "$W_SYSTEM32_DLLS/wmadmod.dll"

    helper_win7sp1 x86_microsoft-windows-wmvdecod_31bf3856ad364e35_6.1.7601.17514_none_c491ee3d3e923b78/wmvdecod.dll
    w_try cp "$W_TMP/x86_microsoft-windows-wmvdecod_31bf3856ad364e35_6.1.7601.17514_none_c491ee3d3e923b78/wmvdecod.dll" "$W_SYSTEM32_DLLS/wmvdecod.dll"

    if [ "$W_ARCH" = "win64" ]; then
        if [ ! -f "$W_CACHE/$W_PACKAGE/windows6.1-KB976932-X64.exe" ]; then
            w_download_to "$W_CACHE/$W_PACKAGE" https://download.microsoft.com/download/0/A/F/0AFB5316-3062-494A-AB78-7FB0D4461357/windows6.1-KB976932-X64.exe f4d1d418d91b1619688a482680ee032ffd2b65e420c6d2eaecf8aa3762aa64c8 windows6.1-KB976932-X64.exe
        fi
        python2 "$W_CACHE/$W_PACKAGE/installcab.py" "$W_CACHE/$W_PACKAGE/windows6.1-KB976932-X64.exe" mediafoundation
        python2 "$W_CACHE/$W_PACKAGE/installcab.py" "$W_CACHE/$W_PACKAGE/windows6.1-KB976932-X64.exe" mf_
        python2 "$W_CACHE/$W_PACKAGE/installcab.py" "$W_CACHE/$W_PACKAGE/windows6.1-KB976932-X64.exe" mfreadwrite
        python2 "$W_CACHE/$W_PACKAGE/installcab.py" "$W_CACHE/$W_PACKAGE/windows6.1-KB976932-X64.exe" wmadmod
        python2 "$W_CACHE/$W_PACKAGE/installcab.py" "$W_CACHE/$W_PACKAGE/windows6.1-KB976932-X64.exe" wmvdecod
        python2 "$W_CACHE/$W_PACKAGE/installcab.py" "$W_CACHE/$W_PACKAGE/windows6.1-KB976932-X64.exe" wmadmod

        w_download_to "$W_CACHE/$W_PACKAGE" https://lutris.net/files/tools/dll/mfplat/x64/mfplat.dll 81c13718b01e698ddc31d13f60335cc6182c9f4cef9e29ece2a5ba5a4f138a1c mfplat.dll.64
        w_try cp "$W_CACHE/$W_PACKAGE/mfplat.dll.64" "$W_SYSTEM64_DLLS/mfplat.dll"

        w_download_to "$W_CACHE/$W_PACKAGE" https://github.com/z0z0z/mf-install/raw/master/syswow64/msmpeg2adec.dll 9c0708bc7b1e49725d2ab7bb1cc67f635284c6452ad4743f2262b71f3ceef287 msmpeg2adec.dll.64
        w_try cp "$W_CACHE/$W_PACKAGE/msmpeg2adec.dll.64" "$W_SYSTEM64_DLLS/msmpeg2adec.dll"

        w_download_to "$W_CACHE/$W_PACKAGE" https://github.com/z0z0z/mf-install/raw/master/syswow64/msmpeg2vdec.dll b023fbd3ef0658512b059f5703e05fff29af3025a4f48da7c3c013d0a8119e3c msmpeg2vdec.dll.64
        w_try cp "$W_CACHE/$W_PACKAGE/msmpeg2vdec.dll.64" "$W_SYSTEM64_DLLS/msmpeg2vdec.dll"

        w_download_to "$W_CACHE/$W_PACKAGE" https://github.com/z0z0z/mf-install/raw/master/syswow64/mferror.dll 34c74d48f31872f195d3fcf5c57278db741bd98424cf54159aa2d8a69e6f869d mferror.dll.64
        w_try cp "$W_CACHE/$W_PACKAGE/mferror.dll.64" "$W_SYSTEM64_DLLS/mferror.dll"

        helper_win7sp1_x64 amd64_microsoft-windows-mediafoundation_31bf3856ad364e35_6.1.7601.17514_none_fa8534ab236134c4/mf.dll
        w_try cp "$W_TMP/amd64_microsoft-windows-mediafoundation_31bf3856ad364e35_6.1.7601.17514_none_fa8534ab236134c4/mf.dll" "$W_SYSTEM64_DLLS/mf.dll"

        helper_win7sp1_x64 amd64_microsoft-windows-mfreadwrite_31bf3856ad364e35_6.1.7601.17514_none_177bed732ea3f85f/mfreadwrite.dll
        w_try cp "$W_TMP/amd64_microsoft-windows-mfreadwrite_31bf3856ad364e35_6.1.7601.17514_none_177bed732ea3f85f/mfreadwrite.dll" "$W_SYSTEM64_DLLS/mfreadwrite.dll"

        helper_win7sp1_x64 amd64_microsoft-windows-sqmapi_31bf3856ad364e35_6.1.7601.17514_none_5c63b87c1b6dc7ec/sqmapi.dll
        w_try cp "$W_TMP/amd64_microsoft-windows-sqmapi_31bf3856ad364e35_6.1.7601.17514_none_5c63b87c1b6dc7ec/sqmapi.dll" "$W_SYSTEM64_DLLS/sqmapi.dll"

        helper_win7sp1_x64 amd64_microsoft-windows-wmadmod_31bf3856ad364e35_6.1.7601.17514_none_e474f0ac34979bc4/wmadmod.dll
        w_try cp "$W_TMP/amd64_microsoft-windows-wmadmod_31bf3856ad364e35_6.1.7601.17514_none_e474f0ac34979bc4/wmadmod.dll" "$W_SYSTEM64_DLLS/wmadmod.dll"

        helper_win7sp1_x64 amd64_microsoft-windows-wmvdecod_31bf3856ad364e35_6.1.7601.17514_none_20b089c0f6efacae/wmvdecod.dll
        w_try cp "$W_TMP/amd64_microsoft-windows-wmvdecod_31bf3856ad364e35_6.1.7601.17514_none_20b089c0f6efacae/wmvdecod.dll" "$W_SYSTEM64_DLLS/wmvdecod.dll"
    fi

    cat > "$W_TMP"/mf.reg <<_EOF_
REGEDIT4
[HKEY_LOCAL_MACHINE\\Software\\Wine\\LicenseInformation]
"msmpeg2adec-AACDecoderV2AddInEnable"=dword:00000001
"msmpeg2adec-AACDecoderV2InSKU"=dword:00000001
"msmpeg2adec-DolbyDigitalDecoderV2AddInEnable"=dword:00000001
"msmpeg2adec-DolbyDigitalDecoderV2InSKU"=dword:00000001
"msmpeg2vdec-H264VideoDecoderV2AddInEnable"=dword:00000001
"msmpeg2vdec-H264VideoDecoderV2InSKU"=dword:00000001
"msmpeg2vdec-MPEG2VideoDecoderV2AddInEnable"=dword:00000001
"msmpeg2vdec-MPEG2VideoDecoderV2InSKU"=dword:00000001
[HKEY_CLASSES_ROOT\\CLSID\\{271C3902-6095-4c45-A22F-20091816EE9E}]
@="MPEG4 Byte Stream Handler"
[HKEY_CLASSES_ROOT\\CLSID\\{271C3902-6095-4c45-A22F-20091816EE9E}\\InprocServer32]
@="mf.dll"
"ThreadingModel"="Both"
[HKEY_CLASSES_ROOT\\CLSID\\{477EC299-1421-4bdd-971F-7CCB933F21AD}]
@="File Scheme Handler"
[HKEY_CLASSES_ROOT\\CLSID\\{477EC299-1421-4bdd-971F-7CCB933F21AD}\\InprocServer32]
@="mf.dll"
"ThreadingModel"="Both"
[HKEY_CLASSES_ROOT\\CLSID\\{48e2ed0f-98c2-4a37-bed5-166312ddd83f}]
@="MFReadWrite Class Factory"
[HKEY_CLASSES_ROOT\\CLSID\\{48e2ed0f-98c2-4a37-bed5-166312ddd83f}\\InprocServer32]
@="mfreadwrite.dll"
"ThreadingModel"="Both"
_EOF_

    w_try_regedit "$W_TMP_WIN"\\mf.reg

    w_override_dlls native,builtin mf
    w_override_dlls native,builtin msmpeg2adec
    w_override_dlls native,builtin msmpeg2vdec
    w_override_dlls native,builtin mferror
    w_override_dlls native,builtin mfplat
    w_override_dlls native,builtin mfreadwrite
    w_override_dlls native,builtin sqmapi
    w_override_dlls native,builtin wmadmod
    w_override_dlls native,builtin wmvdecod
}
